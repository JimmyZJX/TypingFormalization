\section{Metatheory}

This section presents the metatheory of the algorithmic system
presented in the previous section. We show that three main results hold: 
\emph{soundness}, \emph{completeness} and \emph{decidability}.
These three results have been mechanically formalized and proved in the 
Abella theorem prover~\cite{}.

\subsection{Transfer to the Declarative System}
%\jimmy{The transfer rule outputs declarative judgment chains, which are later processed by another declarative relation, handling all the guessing.}

\begin{figure}[t]
\framebox{$\Gm \sto \Om$} $\Gm$ transfers to $\Om$.
\begin{gather*}
\inferrule*[right=$\mathtt{{\sto}}\Om$]
{~}
{\Om \sto \Om}
\quad
\inferrule*[right=$\mathtt{{\sto}\al}$]
{\Om\vdash\tau \\ \Om,[\tau/\al]\Gm \sto \Om}
{\Om,\al,\Gm \sto \Om}
\end{gather*}
\caption{Transfer rules}
\label{fig:trans}
\end{figure}

To aid formalizing the correspondence between the declarative and
algorithmic systems, we use a relation that transfers algorithmic
worklist judgements into corresponding declarative worklist judgements. In essence this
judgment instantiates every existential variable with a well-formed monotype.

The transfer rules are shown in Figure~\ref{fig:trans}.
Rule $\mathtt{{\sto}\al}$ replaces the first existential variable with a well-scoped monotype and
repeats the process in the resulting worklist.
Note that $\Om$, as a declarative worklist, contains no existential
variables. Therefore by recursively applying this rule, the
algorithmic worklist will finally become a declarative one.
In order to maintain well-formedness,
the substitution should affect all the judgments and term variable bindings in the scope of $\al$.

The transfer $\Gm\sto\Om$ is not deterministic.
% \bruno{Do you mean here
%   ``is not deterministic''? Would that be more appropriate?}
On the one hand, there are infinite possibilities to instantiate an existential variable,
thus a judment $\Gm$ could be transferred to different $\Om$'s.
On the other hand, any valid monotype in $\Om$ can be represented by an existential variable in $\Gm$,
thus different $\Gm$'s could be transferred to a single $\Om$.

Lemmas~\ref{lem:insert} and \ref{lem:extract}
generalize Rule $\mathtt{{\sto}\al}$ from substituting the first existential variable
to substituting any existential variable.

\begin{lemma}[Insert]\label{lem:insert}
If $\Gm_L\vdash \tau$ and $\Gm_L, [\tau/\al]\Gm_R \sto \Om$
, then $\Gm_L, \al, \Gm_R \sto \Om$.
\end{lemma}
\begin{lemma}[Extract]\label{lem:extract}
If $\Gm_L, \al, \Gm_R \sto \Om$
, then $\exists \tau$ s.t. $\Gm_L\vdash\tau$ and $\Gm_L, [\tau/\al]\Gm_R \sto \Om$.
\end{lemma}

\begin{figure}[t]
\framebox{$\Om \rto \Om'$} $\Om$ reduces to $\Om'$.
\begin{gather*}
\begin{aligned}
\Om,a &\rto \Om \qquad \Om \qquad \Om,x:A \rto \Om\\
\Om\Vdash A\le B &\rto \Om \text{ when } \Om\vdash A\le B\\
\Om\Vdash e\Lto A &\rto \Om \text{ when } \Om\vdash e\Lto A\\
\Om\Vdash e\To_a \jg &\rto \Om\Vdash[A/a]\jg \text{ when } \Om\vdash e\To A\\
\Om\Vdash \appInfAlg{A}{e} &\rto \Om\Vdash[C/a]\jg \text{ when } \Om\vdash \appInf{A}{e}{C}\\
\end{aligned}
\end{gather*}
\caption{Declarative Worklist Typing.\bruno{I think your names for the
  two relations/definitions aren't great. I think what you're defining
here should be called transfer. The previous relation should probably
be called something different. Maybe something like Declarative
worklist instantiation/realization for the previous relation?}}
\label{fig:decl:worklist}
\end{figure}

Figure~\ref{fig:decl:worklist} relates the worklist-style declarative system
to the original declarative system.
A successful reduction means a valid variable declaration,
a valid subtyping or checking judgment, or a successful guessing for inferences.
Additionally, judgment chains are unfolded to match the original declarative rules.
Although $\Om$ is defined differently from $\Psi$,
our declarative worklist $\Om$ contains a ordered collection of variable definitions,
which naturally fits declarative subtyping and typing.
\bruno{I think that to make things precise what you want to show is
  that you can always define a erasure function that drops the
  judgements from the worklist, and retains only the variable
  declarations (thus becomes a declarative environment). Isn't this
  what you do in your formalization?}
\jimmy{TODO: a erasure function would make things more clear...}
\subsection{Soundness}

Our algorithm is sound with respect to the declarative system.
For any worklist $\Gm$ that reduces successfully,
we can find a valid transfer $\Gm\sto\Om$ that solves all the existential variables,
such that $\Om$ also reduces successfully.
\begin{theorem}[Soundness]
If \emph{wf }$\Gm$ and $\Gm \redto \nil$, then $\exists \Om$ s.t. $\Gm\sto\Om$ and $\Om\redto\nil$.
\end{theorem}

The proof proceeds by induction on derivation of $\Gm\redto\nil$.
Proper applications of lemmas \ref{lem:insert} and \ref{lem:extract}
finish off the theorem.
\bruno{Give a bit more informal explanation here. Something like: If
  $\Gm$ is reducible then we can show that there is always an $\Om$
  where all the corresponding declarative judgements hold.}
\bruno{I wonder if 1 or 2 examples (concrete instantiations of the
  theorem) would be helpful to complement the explanation.}

\subsection{Completeness}

Completeness of the algorithm means that any declarative system has an algorithmic counterpart.

\begin{theorem}[Completeness]
If \emph{wf }$\Gm$ and $\exists \Om$ s.t. $\Gm\sto\Om$ and $\Om\redto\nil$, then $\Gm \redto \nil$.
\end{theorem}

We prove completeness by induction on the derivation of $\Om\redto\nil$.
Since the declarative worklist is reduced judgment-by-judgment,
the induction always analyses the first judgment until it is satisfied.
As the algorithmic system introduces existential variables,
a declarative rule may correspond to multiple algorithmic rules,
and thus we analyse each of the possible cases.

For subtyping, algorithmic Rules 10 and 11 require special treatment.
When the induction reaches the $\mathtt{{\le}{\to}}$ case,
the first judgment is of shape $A_1 \to A_2 \le B_1 \to B_2$.
One of the corresponding algorithmic judgment is $\al \le A \to B$.
However, the case analysis does not imply that $\al$ is fresh in $A$ and $B$,
therefore Rule~10 cannot be applied and the proof gets stuck.
The following lemma helps us out in those cases:
the success in declarative subtyping indicates the freshness of $\al$ in $A$ and $B$
in its corresponding algorithmic judgment.
In other words, the declarative system does not accept infinite types,
thus, as an example, we cannot find a monotype $\tau$ such that $\tau\le 1\to \tau$,
which could be transferred by $\al\le 1\to\al$.

\begin{lemma}[Prune Transfer for Instantiation]
If $(\Gm \Vdash \al \le A \to B) \sto (\Om \Vdash C \le A_1 \to B_1)$ and
$\Om \vdash C \le A_1 \to B_1$, then $\al\notin FV(A) \cup FV(B)$.
\end{lemma}

A symmetric lemma holds for $A\to B \le \al$.

\subsection{Decidability}
\begin{theorem}[Decidability]
Given \emph{wf }$\Gm$, it is decidable whether $\Gm\redto\nil$ or not.
\end{theorem}

We have proven this theorem by a lexicographic group of induction measures\\
$\langle |\Gm|_e, |\Gm|_\Leftrightarrow, |\Gm|_\forall, |\Gm|_{\al}, |\Gm|_\to + |\Gm| \rangle$
on the worklist $\Gm$.
$|\cdot|_e$ and $|\cdot|_\Leftrightarrow$ measure the total ``size'' of teams
and the total ``difficulty'' of judgments, respectively;
$|\cdot|_\forall$ and $|\cdot|_\to$ count the total number of
universal quantifiers and function types, respectively;
$|\cdot|_{\al}$ counts the number of existential variables in the worklist.

\begin{definition}[Worklist Measures]
\begin{gather*}
\begin{aligned}
|\Gm|_e &= \textstyle\sum_{e\Lto A\in\Gm}|e|_e + \sum_{e\To_a \jg\in\Gm}|e|_e +
    \sum_{\appInfAlg{A}{e}\in\Gm}|e|_e\\
\text{where } |x|_e &= |()|_e = 1 \qquad |\lam e|_e = |e|_e + 1\\
|e_1~e_2|_e &= |e_1|_e + |e_2|_e + 1 \qquad |e:A|_e = |e| + 1\\[2mm]
%
|\Gm|_\Leftrightarrow &= \#_{e\Lto A\in\Gm} +
    2\cdot\#_{e\To_a \jg\in\Gm} + 3\cdot\#_{\appInfAlg{A}{e}\in\Gm}\\[2mm]
|\Gm|_\forall &= \textstyle\sum_{e\Lto A\in\Gm}|A|_\forall + \sum_{\appInfAlg{A}{e}\in\Gm}|A|_\forall +
    \sum_{A\le B\in\Gm} |A|_\forall + |B|_\forall\\
\text{where } |1|_\forall &= |a|_\forall = |\al|_\forall = 1\\
|A\to B|_\forall &= |A|_\forall + |B|_\forall \qquad |\all A|_\forall = |A|_\forall + 1\\[2mm]
%
|\Gm|_\to &= \textstyle\sum_{e\Lto A\in\Gm}|A|_\to + \sum_{\appInfAlg{A}{e}\in\Gm}|A|_\to +
    \sum_{A\le B\in\Gm} |A|_\to + |B|_\to\\
\text{where } |1|_\to &= |a|_\to = |\al|_\to = 1\\
|A\to B|_\to &= |A|_\to + |B|_\to + 1 \qquad |\all A|_\to = |A|_\to\\[2mm]
%
|\Gm|_{\al} &= \#_{\al\in\Gm}\\
\end{aligned}
\end{gather*}
\end{definition}

It is not difficult to see that all but two algorithmic reduction rules
decreases the group of measures.
(The result of Rule 29 could be directly reduced by Rule 28, which decreases the measures.)
The two exceptions are Rules 10 and 11; they increases the number of existential variables
without decreasing the number of universal quantifiers.
However, at the same time, they both break the subtyping problem into two sub-problems
(Rule 7 applied right after Rule 10 or 11), in smaller sizes.
Therefore we argue that such split makes the worklist easier, by analyzing a subset of worklist,
which we call \emph{instantiation judgments} $\Gm_i$, with the help of $\Gm_\le$ for the proof.

\begin{definition}[$\Gm_\le, \Gm_i$]
\begin{gather*}
\begin{aligned}
\Gm_\le &:= \nil \mid \Gm_\le, a \mid \Gm_\le, \al \mid \Gm_\le, A\le B\\
\Gm_i &:= \nil \mid \Gm_i, \al\le A \mid \Gm_i, A\le\al \quad
    \text{where } \al\notin FV(A) \cup FV(\Gm_i)
\end{aligned}
\end{gather*}
\end{definition}

\begin{figure}
\framebox{$\Gm\jExt\Gm'$} $\Gm$ extends to $\Gm'$.
\begin{gather*}
\inferrule*[right=$\mathtt{\jExt id}$]
    {~}{\Gm\jExt\Gm}
\qquad
\inferrule*[right=$\mathtt{\jExt solve}$]
    {|A|_\forall = 0 \quad \Gm_L,[A/\al]\Gm_R \jExt \Gm'}{\Gm_L,\al,\Gm_R \jExt \Gm'}
\qquad
\inferrule*[right=$\mathtt{\jExt \al}$]
    {\Gm_L,\al,\Gm_R \jExt \Gm'}{\Gm_L,\Gm_R \jExt \Gm'}
\end{gather*}
\caption{Worklist Extension}\label{fig:worklist_ext}
\end{figure}

\paragraph{Intuition of instantiation decidability}
These instantiation judgments are the ones consumed and produced by Rules 10 and 11.
When there are universal quantifiers in the initial instantiation judgments $\Gm_i$,
the worklist $\Gm,\Gm_i$ will be multi-reduced to match Rule 8 or 9,
which decreases the number of universal quantifiers by 1, and returns a $\Gm',\Gm_\le$.
Otherwise, no more variables will be introduced,
and each instantiation judgment solves one existential variable,
thus finally there will be $|\Gm_i|$ existential variables solved,
with the worklist reduced to $\Gm'$.
$\Gm'$ basically refers to the original part of worklist $\Gm$.
During the reduction, minor changes to worklist might occur, such as
existential variable solving, insertion and instantiation,
but the main structure of it remains unchanged.

Shown in Figure~\ref{fig:worklist_ext},
worklist extension formally describe the minor changes to worklist during algorithmic reduction.
When the algorithm processes the worklist, the first judgment is processed,
and the rest of the worklist roughly remains its shape.
Worklist extension is formally defined by two cases:
existential variable solving ($\mathtt{\jExt solve}$) and insertion ($\mathtt{\jExt \al}$).
Existential variable instantiation, as another common form of worklist manipulation,
i.e. $\Gm_L,\al,\Gm_R \jExt \Gm_L, \al[1], \al[2], [\al[1] \to \al[2] / \al]\Gm_R$,
can be derived with the combination of the 3 rules.
Within expectation, some worklist measures are not changed modulo worklist extension.

\newcommand{\equivGm}[1]{|\Gm|_{#1} = |\Gm'|_{#1}}
\begin{lemma}[Measure Invariants of Worklist Extension]
If $\Gm\sto\Gm'$ then $\equivGm{e}$ and $\equivGm\Leftrightarrow$ and $\equivGm\forall$.
\end{lemma}

With all the definitions, we are able to prove the following instantiation decidability lemma.

\begin{lemma}[Instantiation Decidability]\label{lemma:inst:decidable}
For any well-formed algorithmic worklist $(\Gm, \Gm_i)$,
\begin{enumerate}[1)]
    \item When $|\Gm_i|_\forall = 0$, $(\Gm, \Gm_i) \redto \Gm'$,
        where $|\Gm'|_{\al} = |\Gm|_{\al} - |\Gm_i|$ and $\Gm\sto\Gm'$.
    \item When $|\Gm_i|_\forall > 0$, $(\Gm, \Gm_i) \redto (\Gm', \Gm_\le)$,
        where $|\Gm_\le|_\forall = |\Gm_i|_\forall - 1$ and $\Gm\sto\Gm'$.
\end{enumerate}
\end{lemma}

In short, after reducing any instantiation judgment prefix $\Gm_i$,
the algorithm either decreases the number of $\forall$'s
or solves one existential variable per instantiation judgment.
The proof of this lemma is by induction on the measure $2*|\Gm_i|_\to + |\Gm_i|$
of the instantiation judgment list $\Gm_i$.

In summary, the decidability theorem is shown through a lexicographic group of induction measures
$\langle |\Gm|_e, |\Gm|_\Leftrightarrow, |\Gm|_\forall, |\Gm|_{\al}, |\Gm|_\to + |\Gm| \rangle$.
The critical case is that, whenever we encounter an instantiation judgment at the top of the worklist,
we make use of Lemma~\ref{lemma:inst:decidable}, which reduces $|\Gm|_{\al}$ or $|\Gm|_\forall$
by consuming that instantiation judgment. Other cases are relatively straightforward.

\subsection{Abella}
