\section{Metatheory}\label{sec:metatheory}

This section presents the metatheory of the algorithmic system
presented in the previous section. We show that three main results hold: 
\emph{soundness}, \emph{completeness} and \emph{decidability}.
These three results have been mechanically formalized and proved in the 
Abella theorem prover~\cite{AbellaDesc}.

%-------------------------------------------------------------------------------
\subsection{Declarative Worklist and Transfer}
%\jimmy{The transfer rule outputs declarative judgment chains, which are later processed by another declarative relation, handling all the guessing.}

\begin{figure}[t]
\begin{gather*}
\begin{aligned}
\text{Declarative worklist}\qquad&\Om &::=&\quad \nil \mid \Om, a \mid \Om, x: A \mid \Om \Vdash \jg
\end{aligned}
\end{gather*}
\hfill \framebox{$\Gm \sto \Om$} \hfill $\Gm$ instantiates to $\Om$.
\begin{gather*}
\inferrule*[right=$\mathtt{{\sto}}\Om$]
{~}
{\Om \sto \Om}
\quad
\inferrule*[right=$\mathtt{{\sto}\al}$]
{\Om\vdash\tau \\ \Om,[\tau/\al]\Gm \sto \Om}
{\Om,\al,\Gm \sto \Om}
\end{gather*}
\caption{Declarative Worklists and Instantiation}
\label{fig:trans}
\end{figure}

To aid formalizing the correspondence between the declarative and algorithmic
systems, we introduce the notion of a declarative worklist $\Om$, defined in
Figure~\ref{fig:trans}. A declarative worklist $\Om$ has the same structure as an
algorithmic worklist $\Gm$, but does not contain any extistential variables $\al$.

\paragraph{Worklist instantiation.}
The relation $\Gm \sto \Om$ expresses that the algorithmic worklist $\Gm$ can 
be instiantiated to the declarative worklist $\Om$, by appropriately instantiating
all existential variables $\al$ in $\Gm$ with well-scoped monotypes $\tau$.
The rules of this instantiation relation are shown in Figure~\ref{fig:trans} too.
Rule $\mathtt{{\sto}\al}$ replaces the first existential variable with a well-scoped monotype and
repeats the process on the resulting worklist until no existential variable remains
and thus the algorithmic worklist has become a declarative one.
In order to maintain well-scopedness
the substitution is applied to all the judgments and term variable bindings in the scope of $\al$.

Observe that the instantiation $\Gm\sto\Om$ is not deterministic.
% \bruno{Do you mean here
%   ``is not deterministic''? Would that be more appropriate?}
From left to right, there are infinitely many possibilities to instantiate an existential variable and
thus infinitely many declarative worklists that one can get from an algorithmic one.
In the other direction, any valid monotype in $\Om$ can be abstracted to an
existential variable in $\Gm$. Thus different $\Gm$'s can be instantiated to the same
$\Om$.

Lemmas~\ref{lem:insert} and \ref{lem:extract}
generalize Rule $\mathtt{{\sto}\al}$ from substituting the first existential variable
to substituting any existential variable.

\begin{lemma}[Insert]\label{lem:insert}
If $\Gm_L\vdash \tau$ and $\Gm_L, [\tau/\al]\Gm_R \sto \Om$
, then $\Gm_L, \al, \Gm_R \sto \Om$.
\end{lemma}
\begin{lemma}[Extract]\label{lem:extract}
If $\Gm_L, \al, \Gm_R \sto \Om$
, then $\exists \tau$ s.t. $\Gm_L\vdash\tau$ and $\Gm_L, [\tau/\al]\Gm_R \sto \Om$.
\end{lemma}

\begin{figure}[t]
\hfill \framebox{$\|\Om\|$} \hfill Judgment erasure.
\begin{gather*}
\begin{aligned}
\|\nil\| &= \nil\\
\|\Om,a\| &= \|\Om\|, a\\
\|\Om,x:A\| &= \|\Om\|, x:A\\
\|\Om\Vdash\jg\| &= \|\Om\|
\end{aligned}
\end{gather*}

\hfill \framebox{$\Om \rto \Om'$} \hfill Declarative transfer.
\begin{gather*}
\begin{aligned}
\Om,a &\rto \Om \\  \Om,x:A & \rto \Om\\
\Om\Vdash A\le B &\rto \Om &\text{ when } \|\Om\| \vdash A\le B\\
\Om\Vdash e\Lto A &\rto \Om & \text{ when } \|\Om\| \vdash e\Lto A\\
\Om\Vdash e\To_a \jg &\rto \Om\Vdash[A/a]\jg & \text{ when } \|\Om\| \vdash e\To A\\
\Om\Vdash \appInfAlg{A}{e} &\rto \Om\Vdash[C/a]\jg & \text{ when } \|\Om\| \vdash \appInf{A}{e}{C}\\
\end{aligned}
\end{gather*}
\caption{Declarative Transfer.}
\label{fig:decl:worklist}
\end{figure}

\paragraph{Declarative transfer.}
Figure~\ref{fig:decl:worklist} defines a relation $\Om \rto \Om'$,
which transfers all judgements in the declarative worklists to the
declarative type system. This relation checks that every judgement entry in the worklist
holds using a corresponding conventional declarative judgement. 
The typing contexts of declarative judgements are recovered using an
auxiliary erasure function $\|\Om\|$. The erasure function
simply drops all judgment entries from the worklist, keeping only variable
and type variable declarations.

%-------------------------------------------------------------------------------
\subsection{Non-Overlapping Declarative System}
\label{sec:metatheory:non-overlapping}

DK's declarative system, shown in Figures \ref{fig:decl:sub} and
\ref{fig:decl:typing}, has a few overlapping rules. In contrast, our algorithm
has removed all overlap; at most one rule applies in any given situation.
This discrepancy makes it more difficult to relate the two systems.

To simplify matters, we introduce an intermediate system that is still declarative
in nature, but has no overlap. This intermediate system differs only in a few 
rules from DK's declarative system; these are the changes:
\begin{enumerate}
\item Restrict the shape of $B$ in the rule $\mathtt{\forall L}$ subtyping rule:
$$
\inferrule*[right=$\mathtt{\forall L'}$]
{B \neq \all[b]B' \\ \Psi \vdash \tau \\ \Psi \vdash [\tau/a]A \le B}
{\Psi \vdash \all A \le B}
$$
\item Drop the redundant rule $\mathtt{Decl1I}$,
which can be easily derived by a combination of
$\mathtt{DeclSub}$, $\mathtt{Decl1I{\To}}$ and $\mathtt{{\le}Unit}$:
$$
\inferrule*[right=$\mathtt{DeclSub}$]
{
    \inferrule*[right=$\mathtt{Decl1I{\To}}$]
    {~}
    {\Psi \vdash () \To 1}
    \\
    \inferrule*[right=$\mathtt{{\le}Unit}$]
    {~}
    {\Psi \vdash 1 \le 1}
}
{\Psi \vdash () \Lto 1}
$$
\item Restrict the shapes of $e$ and $A$ in the subsumption rule $\mathtt{DeclSub}$:
$$
\inferrule*[right=$\mathtt{DeclSub'}$]
{e \neq \lam e' \\ A \neq \all A' \\ \Psi \vdash e \To A \\ \Psi \vdash A \le B}
{\Psi \vdash e \Lto B}
$$
\end{enumerate}
The resulting declarative system has no overlapping rules
and more closely resembles the aglorithmic system, which contains
the same shape constraints.

We have proven soundness and completeness of the non-overlapping declarative
system with respect to the overlapping one to establish their equivalence.
Thus the restrictions do not change the expressive power of the system.
Modification (2) is relatively easy to justify, with the derivation given above:
the rule is redundant and can be replaced by a combination of three other rules.
Modifications (1) and (3) require inversion lemmas for the rules that overlap.
Firstly, Rule $\mathtt{\forall L}$ overlaps with Rule $\mathtt{\forall R}$ for the judgment
$\Psi \vdash \all A \le \all[b]B$.
The following inversion lemma for Rule $\mathtt{\forall R}$ resolves the overlap:
\begin{lemma}[Invertibility of $\mathtt{\forall R}$]
If $\Psi \vdash A \le \all B$ then $\Psi, a \vdash A \le B$.
\end{lemma}
The lemma implies that preferring Rule $\mathtt{\forall R}$ does not affect the derivability of the judgment.
Therefore the restriction $B \neq \all[b]B'$ in $\mathtt{\forall L'}$ is valid.

Secondly, Rule $\mathtt{DeclSub}$ overlaps with both $\mathtt{Decl\forall I}$ and $\mathtt{Decl{\to}I}$.
We have proven two inversion lemmas for these overlaps:
\begin{lemma}[Invertibility of $\mathtt{Decl\forall I}$]
If $\Psi \vdash e \Lto \all A$ then $\Psi, a \vdash e \Lto A$.
\end{lemma}
\begin{lemma}[Invertibility of $\mathtt{Decl{\to}I}$]
If $\Psi \vdash \lam e \Lto A \to B$ then $\Psi, x:A \vdash e \Lto B$.
\end{lemma}
These lemmas express that applying the more specific rules, rather than the more general rule $\mathtt{DeclSub}$, does not reduce the expressive power.

The proofs of the above two lemmas rely on an important property of the
declarative system, the \emph{subsumption lemma}. To be able to formulate this
lemma, Figure~\ref{fig:context_subtyping} introduces the \emph{context
subtyping relation} $\Psi \le \Psi'$. Context $\Psi$ subsumes context $\Psi'$ if they
bind the same variables in the same order, but the types $A$ of the term variables $x$
in the former are subtypes of types $A'$ assigned to those term variables in the latter.
Now we can state the subsumption lemma:

\begin{figure}[t]
\framebox{$\Psi' \le \Psi$}
$$\begin{aligned}
\inferrule*[right=$\mathtt{CtxSubEmpty}$]
{~}{\nil \le \nil}\qquad
\inferrule*[right=$\mathtt{CtxSubTyVar}$]
{\Psi' \le \Psi}{\Psi', a \le \Psi, a}\qquad
\inferrule*[right=$\mathtt{CtxSubTmVar}$]
{\Psi' \le \Psi \\ \Psi \vdash A' \le A}{\Psi', x:A' \le \Psi, x:A}\qquad
\end{aligned}$$
\caption{Context Subtyping}
\label{fig:context_subtyping}
\end{figure}

\begin{lemma}[Subsumption]
Given $\Psi' \le \Psi$:
\begin{enumerate}
    \item If $\Psi \vdash e \Lto A$ and $\Psi \vdash A \le A'$ then $\Psi' \vdash e \Lto A$;
    \item If $\Psi \vdash e \To A$ then there exists
        $A'$ s.t. $\Psi \vdash A' \le A$ and $\Psi' \vdash e \To A$;
    \item If $\Psi \vdash \appInf{C}{e}{A}$ and $\Psi \vdash C' \le C$,
        then there exists $A'$ s.t. $\Psi \vdash A' \le A$ and $\Psi' \vdash \appInf{C'}{e}{A'}$.
\end{enumerate}
\end{lemma}
This lemma expresses that any derivation in a context $\Psi$ has a corresponding derivation in any context
$\Psi'$ that it subsumes.

We have tried to follow DK's manual proof of this lemma,
but we discovered several problems in their reasoning that we have been able to address.
Fortunately we have found a different way to prove the lemma.
The details of this issue can be found in Appendix~\ref{}.\bruno{reference}

\paragraph{Three-Way Soundness and Completeness Theorems}
We now have three systems that can be related: DK's overlapping declarative system,
our non-overlapping declarative system, and our algorithmic system.
We have already establishes the first relation, that the two declarative
systems are equivalent.

In what follows, we will establish the soundness of our algorithm directly
against the original overlapping declarative system. However, we have found
that showing completeness of the algorithm is easier against the
non-overlapping declarative system. Of course, as a corollary, it follows that
our algorithm is also complete with respect to DK's declarative system.

%-------------------------------------------------------------------------------
\subsection{Soundness}

Our algorithm is sound with respect to DK's declarative system.
For any worklist $\Gm$ that reduces successfully,
there is a valid instantiation $\Om$ that transfers all judgements successfully to the declarative system.
\begin{theorem}[Soundness]
If \emph{wf }$\Gm$ and $\Gm \redto \nil$, then $\exists \Om$ s.t. $\Gm\sto\Om$ and $\Om\redto\nil$.
\end{theorem}

The proof proceeds by induction on derivation of $\Gm\redto\nil$.
Interesting cases are the those involving existential variable instantiations,
including Rules 10, 11, 21 and 29.
Applications of Lemmas \ref{lem:insert} and \ref{lem:extract}
help analyse the full instantiation of those existential variables.
For example, when $\al$ is solved to $\al[1] \to \al[2]$ in the algorithm,
applying the Extract lemma gives two instantiations $\al[1] = \sigma$ and $\al[2] = \tau$.
It follows that $\al = \sigma \to \tau$, which enables the induction hypothesis
and finishes the corresponding case. Some immediate corollaries which
show the soundness for specific judgement forms are: 


\begin{corollary}[Soundness, single judgment form]
Given \emph{wf }$\Gm$:
\begin{enumerate}
    \item If $\Gm \Vdash A \le B \redto \nil$\\
        then there exist $A', B', \Om$ s.t.
        $\Gm \Vdash A \le B \sto \Om \Vdash A' \le B'$ and $\|\Om\| \vdash A' \le B'$;
    \item If $\Gm \Vdash e \Lto A \redto \nil$\\
        then there exist $e', A', \Om$ s.t.
        $\Gm \Vdash e \Lto A \sto \Om \Vdash e \Lto A'$ and $\|\Om\| \vdash e \Lto A'$;
    \item If $\Gm \Vdash e \To_a \jg \redto \nil$ for any $\jg$\\
        then there exists $\Om, \jg', A$ s.t.
        $\Gm \sto \Om$ and $\|\Om\| \vdash e \To A$;
    \item If $\Gm \Vdash \appInfAlg{A}{e} \redto \nil$ for any $\jg$\\
        then there exists $\Om, \jg', A', C$ s.t.
        $\Gm \Vdash \appInfAlg{A}{e} \sto \Om \Vdash \appInfAlg{A'}{e}[a][\jg']$
            and $\|\Om\| \vdash \appInf{A'}{e}{C}$.
\end{enumerate}
\end{corollary}
\bruno{I do not think the corollary is precisely stated. I think you want todo
  instantiation on $\Gm$ and then use erasure on the judgements, right? As it stands
  it is wrong because there is a ``type error''. Worklists and declarative typing contexts are of different shapes
so the equality does not make sense.}

%-------------------------------------------------------------------------------
\subsection{Completeness}

Completeness of our algorithm means that any derivation in the
declarative system has an algorithmic counterpart.

\begin{theorem}[Completeness]
If \emph{wf }$\Gm$ and $\Gm\sto\Om$ and $\Om\redto\nil$, then $\Gm \redto \nil$.
\label{thm:completeness}
\end{theorem}

We prove completeness by induction on the derivation of $\Om\redto\nil$
and use the non-overlapping declarative system.
Since the declarative worklist is reduced judgment-by-judgment
(shown in Figure~\ref{fig:decl:worklist}),
the induction always analyses the first judgment until it is satisfied.
In Abella, we use a different relation to get the correct induction scheme.

As the algorithmic system introduces existential variables,
a declarative rule may correspond to multiple algorithmic rules,
and thus we analyse each of the possible cases.
\jimmy{Cite DK's proof as the sketch.}

Most cases are relatively easy to prove.
The Insert and Extract lemmas are applied when the algorithm uses existential variables,
but transferred to a monotype for the declarative system,
such as Rules 6, 10, 11, 12-17, 21 and 29.
Algorithmic Rules 10 and 11 require special treatment.
When the induction reaches the $\mathtt{{\le}{\to}}$ case,
the first judgment is of shape $A_1 \to A_2 \le B_1 \to B_2$.
One of the corresponding algorithmic judgments is $\al \le A \to B$.
However, the case analysis does not imply that $\al$ is fresh in $A$ and $B$,
therefore Rule~10 cannot be applied and the proof gets stuck.
The following lemma helps us out in those cases:
the success in declarative subtyping indicates the freshness of $\al$ in $A$ and $B$
in its corresponding algorithmic judgment.
In other words, the declarative system does not accept infinite types.
A symmetric lemma holds for $A\to B \le \al$.
%thus, as an example, we cannot find a monotype $\tau$ such that $\tau\le 1\to \tau$,
%which could be transferred by $\al\le 1\to\al$.

\begin{lemma}[Prune Transfer for Instantiation]
If $(\Gm \Vdash \al \le A \to B) \sto (\Om \Vdash C \le A_1 \to B_1)$ and
$\|\Om\| \vdash C \le A_1 \to B_1$, then $\al\notin FV(A) \cup FV(B)$.
\end{lemma}

The following corollary is derived immediately from Theorem~\ref{thm:completeness}.
\begin{corollary}[Completeness, single judgment form]
Given \emph{wf }$\Gm$ containing no judgment chains:
\begin{enumerate}
    \item If $\Gm \Vdash A \le B \sto \Om \Vdash A' \le B'$ and $\|\Om\| \vdash A' \le B'$
        then $\Gm \Vdash A \le B \redto \nil$;
    \item If $\Gm \Vdash e \Lto A \sto \Om \Vdash e \Lto A'$ and $\|\Om\| \vdash e \Lto A'$
        then $\Gm \Vdash e \Lto A \redto \nil$;
    \item If $\Gm \sto \Om$ and exists $A$ s.t. $\|\Om\| \vdash e \To A$
        then $\Gm \Vdash e \To_a 1 \le 1 \redto \nil$;
    \item If $\Gm \Vdash \appInfAlg{A}{e}[a][1 \to 1] \sto \Om \Vdash \appInfAlg{A'}{e}[a][1 \to 1]$
        and exists $C$ s.t. $\|\Om\| \vdash \appInf{A'}{e}{C}$
        \\
        then $\Gm \Vdash \appInfAlg{A}{e}[a][1 \le 1] \redto \nil$.
\end{enumerate}
\end{corollary}
\bruno{Similar problem to the soundness corollaries here.}

%-------------------------------------------------------------------------------
\subsection{Termination and Decidability}

Finally, we show that our algorithm terminates. In other words:
\begin{theorem}[Decidability]
Given \emph{wf }$\Gm$, it is decidable whether $\Gm\redto\nil$ or not.
\end{theorem}
Our termination proof is based on a lexicographic group of induction measures\\
$\langle |\Gm|_e, |\Gm|_\Leftrightarrow, |\Gm|_\forall, |\Gm|_{\al}, |\Gm|_\to + |\Gm| \rangle$
on the worklist $\Gm$. The definitions of these measures can be found in Figure~\ref{fig:measures}. The first two, 
$|\cdot|_e$ and $|\cdot|_\Leftrightarrow$, measure the total size of terms
and the total difficulty of judgments, respectively. In the latter, check judgements
count for 2, inference judgments for 1 and function inference judgments for 3.
The next two measures, $|\cdot|_\forall$ and $|\cdot|_\to$, count the total number of
universal quantifiers and function types, respectively. Finally,
$|\cdot|_{\al}$ counts the number of existential variables in the worklist.

\begin{figure}[t]
\hfill \framebox{$|\Gm|_e$} \hfill  \llap{Size measure.}
\begin{gather*}
\begin{aligned}
|\Gm|_e &= \textstyle\sum_{e\Lto A\in\Gm}|e|_e + \sum_{e\To_a \jg\in\Gm}|e|_e +
    \sum_{\appInfAlg{A}{e}\in\Gm}|e|_e\\
\text{where } |x|_e &= |()|_e = 1 \qquad |\lam e|_e = |e|_e + 1\\
|e_1~e_2|_e &= |e_1|_e + |e_2|_e + 1 \qquad |e:A|_e = |e| + 1
\end{aligned}
\end{gather*}
\hfill \framebox{$|\Gm|_\Leftrightarrow$} \hfill  \llap{Judgment measure.}
\begin{gather*}
\begin{aligned}
|\Gm|_\Leftrightarrow &= 2\cdot\#_{e\Lto A\in\Gm} +
    \#_{e\To_a \jg\in\Gm} + 3\cdot\#_{\appInfAlg{A}{e}\in\Gm}
\end{aligned}
\end{gather*}
\hfill \framebox{$|\Gm|_\forall$} \hfill  \llap{Polymorphism measure.}
\begin{gather*}
\begin{aligned}
|\Gm|_\forall &= \textstyle\sum_{e\Lto A\in\Gm}|A|_\forall + \sum_{\appInfAlg{A}{e}\in\Gm}|A|_\forall +
    \sum_{A\le B\in\Gm} |A|_\forall + |B|_\forall\\
\text{where } |1|_\forall &= |a|_\forall = |\al|_\forall = 1\\
|A\to B|_\forall &= |A|_\forall + |B|_\forall \qquad |\all A|_\forall = |A|_\forall + 1
\end{aligned}
\end{gather*}
\hfill \framebox{$|\Gm|_\to$} \hfill  \llap{Function measure.}
\begin{gather*}
\begin{aligned}
|\Gm|_\to &= \textstyle\sum_{e\Lto A\in\Gm}|A|_\to + \sum_{\appInfAlg{A}{e}\in\Gm}|A|_\to +
    \sum_{A\le B\in\Gm} |A|_\to + |B|_\to\\
\text{where } |1|_\to &= |a|_\to = |\al|_\to = 1\\
|A\to B|_\to &= |A|_\to + |B|_\to + 1 \qquad |\all A|_\to = |A|_\to
\end{aligned}
\end{gather*}
\hfill \framebox{$|\Gm|_{\al}$} \hfill  \llap{Existential measure.}
\begin{gather*}
\begin{aligned}
|\Gm|_{\al} &= \#_{\al\in\Gm}\\
\end{aligned}
\end{gather*}
\caption{Worklist measures}
\label{fig:measures}
\end{figure}

It is not difficult to see that all but two algorithmic reduction rules
decrease the group of measures.  (The result of Rule 29 could be directly
reduced by Rule 28, which decreases the measures.) The two exceptions are Rules
10 and 11. Both rules increase the number of existential variables without
decreasing the number of universal quantifiers. However, they are both
immediately followed by Rule 7, which breaks the subtyping problem into two
smaller problems of the form $\al \le A$ and $A \le \al$ which we call
\emph{instantiation judgements}.

We now show that entirely reducing these smaller problems leaves the worklist
in a state with an overall smaller measure. Our starting point is a 
worklist of the form $\Gm,\Gm_i$ where $\Gm_i$ are instantiation judgments.
\begin{gather*}
\begin{aligned}
\Gm_i &:= \nil \mid \Gm_i, \al\le A \mid \Gm_i, A\le\al \quad
    \text{where } \al\notin FV(A) \cup FV(\Gm_i)
\end{aligned}
\end{gather*}
Fully reducing these instantiation judgments at the top of the worklist
has a twofold impact. Firstly, new entries may be pushed onto the worklist which
are not instantiation judgments. This only happens when $\Gm_i$ contains a universal quantifier
that is reduced by Rule 8 or 9. The new entries then are of the form $\Gm_\forall$:
\begin{gather*}
\begin{aligned}
\Gm_\le &:= \nil \mid \Gm_\le, a \mid \Gm_\le, \al \mid \Gm_\le, A\le B
\end{aligned}
\end{gather*}
Secondly, reducing the instantiation judgments may also affect the remainder of the worklist $\Gm$,
by solving existing existentials and introducing new ones. This worklist update is captured in the 
update judgement $\Gm \jExt \Gm'$ defined in Figure~\ref{fig:worklist_ext}.
For instance, existential variable instantiation, 
i.e. $\Gm_L,\al,\Gm_R \jExt \Gm_L, \al[1], \al[2], [\al[1] \to \al[2] / \al]\Gm_R$,
can be derived as a combination of the three rules that define the update relation.

\begin{figure}
\hfill \framebox{$\Gm\jExt\Gm'$} \hfill \llap{$\Gm$ updates to $\Gm'$}.
\begin{gather*}
\inferrule*[right=$\mathtt{\jExt id}$]
    {~}{\Gm\jExt\Gm}
\qquad
\inferrule*[right=$\mathtt{\jExt solve}$]
    {|A|_\forall = 0 \quad \Gm_L,[A/\al]\Gm_R \jExt \Gm'}{\Gm_L,\al,\Gm_R \jExt \Gm'}
\qquad
\inferrule*[right=$\mathtt{\jExt \al}$]
    {\Gm_L,\al,\Gm_R \jExt \Gm'}{\Gm_L,\Gm_R \jExt \Gm'}
\end{gather*}
\caption{Worklist Update}\label{fig:worklist_ext}
\end{figure}

The good news is that worklist update does not affect the three main worklist measures:
\newcommand{\equivGm}[1]{|\Gm|_{#1} = |\Gm'|_{#1}}\label{lemma:inst:invariant}
\begin{lemma}[Measure Invariants of Worklist Extension]
If $\Gm\sto\Gm'$ then $\equivGm{e}$ and $\equivGm\Leftrightarrow$ and $\equivGm\forall$.
\end{lemma}

Moreover, we can characterise the reduction of the instantiation judgments as follows.
\begin{lemma}[Instantiation Decidability]\label{lemma:inst:decidable}
For any well-formed algorithmic worklist $(\Gm, \Gm_i)$,
\begin{enumerate}[1)]
    \item When $|\Gm_i|_\forall = 0$, $(\Gm, \Gm_i) \redto \Gm'$,
        where $|\Gm'|_{\al} = |\Gm|_{\al} - |\Gm_i|$ and $\Gm\sto\Gm'$.
    \item When $|\Gm_i|_\forall > 0$, $(\Gm, \Gm_i) \redto (\Gm', \Gm_\le)$,
        where $|\Gm_\le|_\forall = |\Gm_i|_\forall - 1$ and $\Gm\sto\Gm'$.
\end{enumerate}
\end{lemma}
Hence, reducing the instantiation judgment prefix $\Gm_i$ either
decreases the number of universal quantifiers or 
the algorithm either decreases the number of $\forall$'s
or solves one existential variable per instantiation judgment.
The proof of this lemma proceeds by induction on the measure $2*|\Gm_i|_\to + |\Gm_i|$
of the instantiation judgment list $\Gm_i$.

Let us go back to the whole algorithm and summarize our findings.
The decidability theorem is shown through a lexicographic group of induction measures
$\langle |\Gm|_e, |\Gm|_\Leftrightarrow, |\Gm|_\forall, |\Gm|_{\al}, |\Gm|_\to + |\Gm| \rangle$
which is decreased by nearly all rules.
In the exceptional case that the measure does not decrease immediately, 
we encounter an instantiation judgment at the top of the worklist. We can then
make use of Lemma~\ref{lemma:inst:decidable} to show that $|\Gm|_{\al}$ or $|\Gm|_\forall$ decreases
when that instantiation judgment is consumed. Moreover, Lemma~\ref{lemma:inst:invariant} establishes
that no higher-priority measure component increases. Hence, in the exceptional case we have an overall measure decrease too.

Combining all three main results (soundness, completeness and termination), we conclude that the declarative system is decidable
by means of our algorithm.
\begin{corollary}[Decidability of Declarative Typing]
Given \emph{wf }$\Om$, it is decidable whether $\Om\redto\nil$ or not.
\end{corollary}
\subsection{Abella}
