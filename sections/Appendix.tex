
\section{Appendix}

\subsection{Formal Definitions for Worklist Measures}

\begin{figure}[h!]
    \begin{minipage}[t]{.5\textwidth}
        \centering\framebox{$|\Gm|_e$, $|\jg|_e$, $|e|_e$} {Size measure.}
        \begin{gather*}
            \begin{aligned}
            |\Gm|_e &= \sum_{\jg \in \Gm} |\jg|_e\\[2mm]
            |A \le B|_e &= 0\\
            |e \Lto A|_e &= |e|_e\\
            |e \To \jg|_e &= |e|_e + |\jg|_e\\
            |\appInfAlg{A}{e}|_e &= |e|_e + |\jg|_e\\[2mm]
            |x|_e &= |()|_e = 1\\
            \qquad |\lam e|_e &= |e|_e + 1\\
            |e_1~e_2|_e &= |e_1|_e + |e_2|_e + 1\\
            |e:A|_e &= |e|_e + 1
            \end{aligned}
        \end{gather*}
        
        \centering\framebox{$|\Gm|_\Leftrightarrow$, $|\jg|_\Leftrightarrow$} {Judgment measure.}
        \begin{gather*}
            \begin{aligned}
            |\Gm|_\Leftrightarrow &= \sum_{\jg \in \Gm} |\jg|_e\\[2mm]
            % 2\cdot\#_{e\Lto A\in\Gm} +
            %    \#_{e\To_a \jg\in\Gm} + 3\cdot\#_{\appInfAlg{A}{e}\in\Gm}
            |A \le B|_\Leftrightarrow &= 0\\
            |e \Lto A|_\Leftrightarrow &= 2\\
            |e \To \jg|_\Leftrightarrow &= |\jg|_\Leftrightarrow + 1\\
            |\appInfAlg{A}{e}|_\Leftrightarrow &= |\jg|_\Leftrightarrow + 3
            \end{aligned}
        \end{gather*}
        \centering\framebox{$|\Gm|_{\al}$} {Existential measure.}
        \begin{gather*}
            \begin{aligned}
            |\Gm|_{\al} &= \#_{\al\in\Gm}\\
            \end{aligned}
        \end{gather*}
    \end{minipage}%
    \begin{minipage}[t]{.5\textwidth}
        \centering\framebox{$|\Gm|_\forall$, $|\jg|_\forall$, $|A|_\forall$} {Polymorphism measure.}
        \begin{gather*}
            \begin{aligned}
            |\Gm|_\Leftrightarrow &= \sum_{\jg \in \Gm} |\jg|_\forall\\[2mm]
            |A \le B|_\forall &= |A|_\forall + |B|_\forall\\
            |e \Lto A|_\forall &= |A|_\forall\\
            |e \To \jg|_\forall &= |\jg|_\forall\\
            |\appInfAlg{A}{e}|_\forall &= |A|_\forall + |\jg|_\forall\\[2mm]
            |1|_\forall &= |a|_\forall = |\al|_\forall = 1\\
            |A\to B|_\forall &= |A|_\forall + |B|_\forall\\
            |\all A|_\forall &= |A|_\forall + 1
            \end{aligned}
        \end{gather*}
        
        \centering\framebox{$|\Gm|_\to$, $|\jg|_\to$, $|A|_\to$} {Function measure.}
        \begin{gather*}
            \begin{aligned}
            |\Gm|_\to &= \sum_{\jg \in \Gm} |\jg|_\forall\\[2mm]
            |A \le B|_\forall &= |A|_\forall + |B|_\forall\\
            |e \Lto A|_\forall &= |A|_\forall\\
            |e \To \jg|_\forall &= |\jg|_\forall\\
            |\appInfAlg{A}{e}|_\forall &= |A|_\forall + |\jg|_\forall\\[2mm]
            |1|_\to &= |a|_\to = |\al|_\to = 1\\
            |A\to B|_\to &= |A|_\to + |B|_\to + 1\\
            |\all A|_\to &= |A|_\to
            % \sum_{e\Lto A\in\Gm}|A|_\to + \sum_{\appInfAlg{A}{e}\in\Gm}|A|_\to +
            %     \sum_{A\le B\in\Gm} |A|_\to + |B|_\to\\
            \end{aligned}
        \end{gather*}
    \end{minipage}
\Description{Worklist measures}
\caption{Worklist measures}
\label{fig:measures}
\end{figure}

\subsection{Broken Lemmas in DK's Papers}
\label{appendix:false_lemmas}

We found false lemmas in the manual proofs of DK' two papers
\cite{dunfield2013complete} and \cite{DunfieldIndexed}.
\begin{itemize}
    \item
        In the first paper, Lemma 29 on page 9 of its appendix says:
        \begin{lemma}[Parallel Admissibility of~\cite{dunfield2013complete}]~\\
        If $\Gamma_L \longrightarrow \Delta_L$ and
        $\Gamma_L, \Gamma_R \longrightarrow \Delta_L, \Delta_R$ then:
        \begin{enumerate}
            \item $\Gamma_L,\al,\Gamma_R \longrightarrow \Delta_L, \al, \Delta_R$
            \item If $\Delta_L \vdash \tau'$ then
                $\Gamma_L,\al,\Gamma_R \longrightarrow \Delta_L, \al = \tau', \Delta_R$.
            \item If $\Gamma_L \vdash \tau$ and $\Delta_L \vdash \tau'$ and
                $[\Delta_L]\tau = [\Delta_L]\tau'$, then
                $\Gamma_L, \al = \tau, \Gamma_R \longrightarrow \Delta_L, \al = \tau', \Delta_R$.
        \end{enumerate}
        \end{lemma}

        We give a counter-example to this lemma:\\
        Pick $\Gm_L = \nil, \Gm_R = \bt, \Delta_L = \bt, \Delta_R = \nil$, then both conditions
        $\nil\longrightarrow \bt$ and $\bt\longrightarrow \bt$ hold, but the first conclusion
        $\al,\bt \longrightarrow \bt,\al$ does not hold.
    \item
        In the second paper, as an extended work to the first paper, Lemma 26 on page 22 of its appendix says:
        \begin{lemma}[Parallel Admissibility of~\cite{DunfieldIndexed}]~\\
        If $\Gamma_L \longrightarrow \Delta_L$ and
        $\Gamma_L, \Gamma_R \longrightarrow \Delta_L, \Delta_R$ then:
        \begin{enumerate}
            \item $\Gamma_L,\al:\kappa,\Gamma_R \longrightarrow \Delta_L, \al:\kappa, \Delta_R$
            \item If $\Delta_L \vdash \tau' : \kappa$ then
                $\Gamma_L,\al:\kappa,\Gamma_R \longrightarrow \Delta_L, \al:\kappa = \tau', \Delta_R$.
            \item If $\Gamma_L \vdash \tau : \kappa$ and $\Delta_L \vdash \tau' types$ and
                $[\Delta_L]\tau = [\Delta_L]\tau'$, then
                $\Gamma_L, \al:\kappa = \tau, \Gamma_R \longrightarrow \Delta_L, \al:\kappa = \tau', \Delta_R$.
        \end{enumerate}
        \end{lemma}
        
        A similar counter-example is given:\\
        Pick $\Gm_L = \nil, \Gm_R = \bt:\star, \Delta_L = \bt:\star, \Delta_R = \nil$, then both conditions
        $\nil\longrightarrow \bt:\star$ and $\bt:\star\longrightarrow \bt:\star$ hold, but the first conclusion
        $\al:\kappa,\bt:\star \longrightarrow \bt:\star,\al:\kappa$ does not hold.
\end{itemize}

\subsection{A Fix to DK's Subsumption Lemma}
\label{appendix:subsumption}

Let's first recall the lemma:
\begin{lemma}[Subsumption]
Given $\Psi' \le \Psi$:
\begin{enumerate}
    \item If $\Psi \vdash e \Lto A$ and $\Psi \vdash A \le A'$ then $\Psi' \vdash e \Lto A'$;
    \item If $\Psi \vdash e \To B$ then there exists
        $B'$ s.t. $\Psi \vdash B' \le B$ and $\Psi' \vdash e \To B'$;
    \item If $\Psi \vdash \appInf{A}{e}{C}$ and $\Psi \vdash A' \le A$,
        then there exists $C'$ s.t. $\Psi \vdash C' \le C$ and $\Psi' \vdash \appInf{A'}{e}{C'}$.
\end{enumerate}
\end{lemma}

\paragraph{Problems in DK's Manual Proof}
We tried to follow DK's manual proof for this lemma.
While being written in a clear format and providing enough details,
the proof is not fully accepted by the proof assistant.
Specifically, the first two applications of induction hypotheses on page 22 are not accepted.
Either of them seems to use a slightly different ``induction hypothesis'' than the true one.

\paragraph{A Fix to the Proof}
We make use of our worklist measures for the induction.
Recall that $|e|_e$ measures term size;
and the judgment measure counts checking as 2, inference as 1 and application inference as 3;
and $|A|_\forall$ counts the number of $\forall$'s in a type.

The proof is by a nested mutual induction on the lexicographical order of the measures
$$\langle |e|_e, |\cdot|_\Leftrightarrow, |A|_\forall + |A'|_\forall \rangle,$$
where the second measure is 2 for checking (1), 1 for inference (2) and 3 for application inference (3);
and the third measure does not apply to case (2) since no $A$ is used.

All but two cases can be finished easily following the declarative typing derivation,
and the proof shares a similar structure to DK's.
One tricky case related to Rule $\mathtt{Decl\forall I}$ indicates that $A$ has the shape $\all A_0$,
thus the subtyping relation derives from either $\mathtt{{\le}\forall L}$ or $\mathtt{{\le}\forall R}$.
For each of the case, the third measure $|A|_\forall + |A'|_\forall$ decreases
(the $\mathtt{{\le}\forall L}$ case requires a type substitution lemma obtaining
$\Psi \vdash e \Lto [\tau/a]A_0$ from the typing derivation).

Another tricky case is $\mathtt{Decl{\to}I}$.
When the subtyping relation is derived from $\mathtt{{\le}{\to}}$,
a simple application of induction hypothesis finishes the proof.
When the subtyping relation is derived from $\mathtt{{\le}\forall R}$,
$|A'|_\forall$ decreases, and thus the induction hypothesis finishes this case.

\subsection{Translation Table for the Proof Scripts}
In the proof scripts, we use textual relational definitions
rather than the symbolic ones used in the paper.
The mapping, shown in Table~\ref{table:translation_table}, should be helpful for anyone who reads the script.

\afterpage{%
\clearpage% Flush earlier floats (otherwise order might not be correct)
\begin{landscape}% Landscape page

\begin{table}[ht]
\renewcommand{\arraystretch}{1.3} 
\caption{Translation Table for the Proof Scripts}
\centering
\begin{tabular}{@{}llll@{}}
\toprule
Symbol & Abella textual relation & File (.thm) & Description\\
\midrule
$A$    & {\tt ty, wft, wfta} & typing &
    The "type" type, decl./alg. well-formedness\\
$e$    & {\tt tm, wftm} & typing &
    The "term" type, (alg.) well-formedness\\
$\Psi, \Gm$ & {\tt olist, wfj} & typing &
    {\tt olist} is Abella's built-in list type, i.e. {\tt [o]}\\
$\jg$  & {\tt judgment, wfjg} & typing &
    Judgment chain and its well-formedness\\

$\Gm\rto\Gm'$ & {\tt reduction} & smallStep &
    Algorithmic reduction: paper version\\
$\Gm\redto\nil$ & {\tt judge} & typing &
    ({\tt judge} $\Gm$): a success reduction on $\Gm$\\

$\Gm \sto \Om$ & {\tt tex} & trans &
    "transfer existential variables"\\
$\Om\redto\nil$ & {\tt dc, dcl} & trans, dcl &
    Declarative chain representation\\

$\Psi'\le\Psi$ & {\tt esub} & declTyping & Declarative context subtyping\\

$\Gm\jExt\Gm'$ & {\tt jExt} & inst\_decidable & "Judgment extension"\\
$\Gm_i$ & {\tt iexp} & inst\_decidable & instantiation judgments ($\Gm \vdash_{wf} \Gm_i$)\\
$\Gm_\le$ & {\tt subExp} & inst\_decidable & subtyping judgments\\

$|\cdot|_e$ & {\tt tmSize, tmSizeJ, tmSizel} & declTyping, decidability &
    Size measure for term, judgment chain or context\\
$|\cdot|_\Leftrightarrow$ & {\tt m\_judgeJ, m\_judge} & decidability &
    Judgment measure for judgment chain or context\\
$|\cdot|_{\al}$ & {\tt nVar} & inst\_decidable &
    Existential measure for context\\
$|\cdot|_\forall$ & {\tt order, orderJ, orderl} & order, inst\_decidable &
    Polymorphism measure for type, judgment chain or context\\
$|\cdot|_\to$ & {\tt depth, depthJ, depthl} & order, decidability &
    Function measure for type, judgment chain or context\\
\bottomrule
\end{tabular}
\label{table:translation_table}
\end{table}

\end{landscape}
\clearpage% Flush page
}
